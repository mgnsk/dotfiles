#!/usr/bin/env bash

set -eo pipefail

target="$1"

if [ "$target" != "prs" ] && [ "$target" != "issues" ] && [ "$target" != "events" ]; then
	echo "usage: gh-fzf {prs|issues|events}"
	exit 1
fi

set -e

export target

pr_query="$(
	cat <<-'EOF'
		query($name: String!, $owner: String!, $number: Int!) {
			repository(owner: $owner, name: $name) {
				pullRequest(number: $number) {
					number,
					title,
					url,
					updatedAt,
					createdAt,
					state,
					author {
						login
					},
					body,
					comments(last: 100) {
						nodes {
							updatedAt,
							createdAt,
							url,
							author {
								login
							},
							minimizedReason,
							body
						}
					},
					reviews(last: 100) {
						nodes {
							updatedAt,
							createdAt,
							url,
							state,
							author {
								login
							},
							minimizedReason,
							body,
							comments(last: 100) {
								nodes {
									updatedAt,
									createdAt,
									url,
									author {
										login
									},
									minimizedReason,
									position,
									startLine,
									line,
									originalStartLine,
									originalLine,
									diffHunk,
									body
								}
							}
						}
					}
				}
			}
		}
	EOF
)"

export pr_query

pr_jq_template="$(
	cat <<-'EOF'
		.data.repository.pullRequest | .comments = ([
			# Comments.
			(.comments.nodes[]),

			# Reviews.
			(.reviews.nodes[] | select(.body != "")), # Skip placeholder reviews.

			# Review comments.
			(.reviews.nodes[] | . as $review | .comments.nodes[] | . as $comment | .state = $review.state | .diffHunk = ([
				(.diffHunk | split("\n") | . as $arr | to_entries[] |
				# Note: line numbers are for files not diff, can't use them here unless we see all hunks.
				if $comment.originalStartLine == null and $comment.originalLine != null then
					select(.key > ($arr|length)-5)
				else
					select(true)
				end
				| .value)
			] | join("\n")))
		] | sort_by(.createdAt))
	EOF
)"

export pr_jq_template

issue_query="$(
	cat <<-'EOF'
		query($name: String!, $owner: String!, $number: Int!) {
			repository(owner: $owner, name: $name) {
				issue(number: $number) {
					number,
					title,
					url,
					updatedAt,
					createdAt,
					state,
					author {
						login
					},
					body,
					comments(last: 100) {
						nodes {
							updatedAt,
							createdAt,
							url,
							author {
								login
							},
							minimizedReason,
							body
						}
					}
				}
			}
		}
	EOF
)"

export issue_query

issue_jq_template="$(
	cat <<-'EOF'
		.data.repository.issue | .comments = .comments.nodes
	EOF
)"

export issue_jq_template

issue_pr_go_template="$(
	cat <<-'EOF'
		# #{{.number}} {{.title}} ({{.state}})
		## *{{timeago .createdAt}}{{if and .updatedAt (gt .updatedAt .createdAt)}}{{printf " (updated %s)" (timeago .updatedAt) }}{{end}}{{if .author}}{{printf " (%s)" .author.login}}{{end}}:*
		*{{.url}}*

		{{.body}}

		{{range .comments}}
			---

			## *{{timeago .createdAt}}{{if and .updatedAt (gt .updatedAt .createdAt)}}{{printf " (updated %s)" (timeago .updatedAt) }}{{end}}{{if .author}} {{printf "(%s)" .author.login}}{{end}}{{if .state}} {{.state}}{{end}}:*
			*{{.url}}*
			{{if .minimizedReason}}*minimized: {{.minimizedReason}}*{{end}}
			{{if .path}}*path: {{.path}}*{{end}}
			{{if .diffHunk}}{{printf "```diff\n%s\n```" .diffHunk}}{{end}}
			{{.body}}
		{{end}}
	EOF
)"

export issue_pr_go_template

issue_pr_list_go_template="$(
	cat <<-'EOF'
		{{- range .}}{{.number | autocolor "yellow"}} {{timeago .createdAt | autocolor "red"}} {{printf "(%s)" .author.login | autocolor "blue"}} {{.title | replace "\n" " "}} ({{.state}}){{"\n"}}{{end -}}
	EOF
)"

export issue_pr_list_go_template

function render-markdown {
	set -euo pipefail

	# mdcat: Best readability. Respects user colors.
	mdcat -p --ansi --columns "$FZF_PREVIEW_COLUMNS"

	# rich-cli: Less readable. Respects user colors.
	# rich --markdown --force-terminal --emoji -

	# HTML options.
	# cmark-gfm --to html --width "$FZF_PREVIEW_COLUMNS" | elinks -dump -dump-color-mode 3
	# marked --gfm | elinks -dump -dump-color-mode 3

	# glow: Poor performance. Italic URLs don't display.
	# glow --pager --style auto --width "$FZF_PREVIEW_COLUMNS"
}

export -f render-markdown

function gh-search {
	set -euo pipefail

	repo="$1"
	query="$2"

	if [ "$target" == "prs" ] || [ "$target" == "issues" ]; then
		# Handle empty query.
		if [ "$query" == "{q}" ] || [ "$query" == "" ]; then
			gh "${target::-1}" list \
				--json number,title,state,createdAt,updatedAt,author \
				--jq 'sort_by(.updatedAt) | reverse' |
				gh-tpl --color "$issue_pr_list_go_template"
			exit
		fi

		gh search "$target" \
			--repo "$repo" \
			--sort updated \
			--json number,title,state,createdAt,author \
			"$query" |
			gh-tpl --color "$issue_pr_list_go_template"
	fi
}

export -f gh-search

function gh-view {
	set -euo pipefail

	number="$1"

	if [ "$number" == "" ]; then
		echo "usage: gh-view {number}"
		exit 1
	fi

	if [ "$target" == "prs" ]; then
		gh api graphql \
			-F owner='{owner}' \
			-F name='{repo}' \
			-F number="$number" \
			-f query="$pr_query" \
			--jq "$pr_jq_template" |
			gh-tpl "$issue_pr_go_template" |
			render-markdown
	elif [ "$target" == "issues" ]; then
		gh api graphql \
			-F owner='{owner}' \
			-F name='{repo}' \
			-F number="$number" \
			-f query="$issue_query" \
			--jq "$issue_jq_template" |
			gh-tpl "$issue_pr_go_template" |
			render-markdown
	fi
}

export -f gh-view

# PRs and issues use github's search.
if [ "$target" == "prs" ] || [ "$target" == "issues" ]; then
	repo="$(gh repo view --json nameWithOwner --jq '.nameWithOwner')"
	export FZF_DEFAULT_COMMAND="bash -c \"gh-search $repo {q} 2>&1\""

	fzf \
		--ansi \
		--phony \
		--query '' \
		--no-sort \
		--bind "change:reload:sleep 0.2; $FZF_DEFAULT_COMMAND || true" \
		--bind ctrl-u:preview-half-page-up,ctrl-d:preview-half-page-down \
		--bind shift-up:preview-top,shift-down:preview-bottom \
		--header "Ctrl-L: web browser, Ctrl-O: diff" \
		--bind "ctrl-l:execute-silent(gh ${target::-1} view {1} --web)" \
		--bind "ctrl-o:execute(gh pr diff {1} | delta)" \
		--preview 'bash -c "gh-view {1}" | rg --colors=match:fg:black --colors=match:bg:yellow --color=always --passthru {q}' \
		--preview-window=wrap \
		--prompt "$target> "

	exit
fi

event_list_jq_template="$(
	cat <<-'EOF'
		[($user_events[]), ($received_events[])] | add | sort_by(.created_at) | reverse
	EOF
)"

# TODO: .type trimsuffix "Event"
event_list_go_template="$(
	cat <<-'EOF'
		{{- range . -}}
		{{- timeago .created_at | autocolor "red"}} {{printf "(%s@%s)" .actor.login .repo.name | autocolor "blue" -}}
		{{- if .payload.pull_request}} {{printf "(#%v) %s" .payload.pull_request.number .payload.pull_request.title | autocolor "cyan"}}{{end -}}
		{{- if .payload.issue}} {{printf "(#%v) %s" .payload.issue.number .payload.issue.title | autocolor "cyan"}}{{end -}}
		{{- if .payload.ref}} {{printf "(%s)" .payload.ref | autocolor "cyan"}}{{end -}}
		{{- printf " %s" (trimSuffix "Event" .type) | autocolor "yellow" -}}
		{{- if .payload.action}} {{.payload.action}}{{end -}}
		{{- if .payload.review.state}} {{.payload.review.state}}{{end -}}
		{{- if .payload.review.commit_id}} {{.payload.review.commit_id | autocolor "yellow"}}{{end -}}
		{{- if .payload.review.body}} {{(regexReplaceAllLiteral "[\r\n]+" .payload.review.body " ")}}{{end -}}
		{{- if .payload.comment.body}} {{(regexReplaceAllLiteral "[\r\n]+" .payload.comment.body " ")}}{{end -}}
		{{- if .payload.commits}} {{.payload.size}} {{int .payload.size | plural "commit" "commits"}}{{end -}}
		{{- "\n" -}}
		{{- end -}}
	EOF
)"

# Events uses fzf filtering.
if [ "$target" == "events" ]; then
	user=$(gh api user --jq '.login')

	# List events for the authenticated user.
	user_events="$(
		gh api \
			-H "Accept: application/vnd.github+json" \
			-H "X-GitHub-Api-Version: 2022-11-28" \
			"/users/$user/events"
	)"

	# List events received by the authenticated user.
	received_events="$(
		gh api \
			-H "Accept: application/vnd.github+json" \
			-H "X-GitHub-Api-Version: 2022-11-28" \
			"/users/$user/received_events"
	)"

	all_events=$(
		jq \
			-n \
			-s \
			--slurpfile user_events <(echo "$user_events") \
			--slurpfile received_events <(echo "$received_events") \
			"$event_list_jq_template"
	)

	echo "$all_events" | gh-tpl --color "$event_list_go_template" |
		fzf \
			--ansi \
			--no-sort \
			--prompt "$target> "

	exit
fi
