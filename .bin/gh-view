#!/usr/bin/env bash

set -euo pipefail

target="$1"
number="$2"

if [ "$target" == "pr" ]; then
	# PR with body and comments. The PR body is treated as the first comment.
	pr=$(gh pr view "$number" --json number,title,state,createdAt,author,body,comments \
		--jq '. as $parent | {createdAt, number, title, state, login: .author.login, comments: [({createdAt: $parent.createdAt, login: $parent.author.login, body: $parent.body}), ($parent.comments[] | {createdAt, login: .author.login, body})]}')

	# Diff comments.
	diff_comments=$(gh api "repos/{owner}/{repo}/pulls/$number/comments" | jq ' [.[] | {createdAt: .created_at, login: .user.login, diff_hunk, body}]')

	# PR with all comments merged and sorted.
	pr_all=$(jq -n -s --argjson pr "$pr" --argjson diff_comments "$diff_comments" '{createdAt: $pr.createdAt, number: $pr.number, title: $pr.title, state: $pr.state, login: $pr.login, comments: ($pr.comments + $diff_comments) | sort_by(.createdAt)}')

	# Display the PR using gh-tpl: https://github.com/mgnsk/gh-tpl.
	echo "$pr_all" | gh-tpl '# #{{.number}} {{.title}}{{"\n"}}state: {{.state}}{{"\n\n\n"}}{{range .comments}}{{"\n\n\n"}}# *{{timeago .createdAt}} {{printf "(%s)" .login}}:*{{"\n"}}{{if .diff_hunk}}{{printf "```diff\n%s\n```" .diff_hunk}}{{end}}{{"\n"}}{{.body}}{{end}}' | glow -s auto

	# Show the full diff.
	gh pr diff "$number" | delta
elif [ "$target" == "issue" ]; then
	# Issue with comments.
	pr=$(gh issue view "$number" --json number,title,state,createdAt,author,body,comments \
		--jq '. as $parent | {createdAt, number, title, state, login: .author.login, comments: [({createdAt: $parent.createdAt, login: $parent.author.login, body: $parent.body}), ($parent.comments[] | {createdAt, login: .author.login, body})]}')

	# Display the issue using gh-tpl: https://github.com/mgnsk/gh-tpl.
	echo "$pr" | gh-tpl '# #{{.number}} {{.title}}{{"\n"}}state: {{.state}}{{"\n\n\n"}}{{range .comments}}{{"\n\n\n"}}# *{{timeago .createdAt}} {{printf "(%s)" .login}}:*{{"\n"}}{{if .diff_hunk}}{{printf "```diff\n%s\n```" .diff_hunk}}{{end}}{{"\n"}}{{.body}}{{end}}' | glow -s auto
else
	echo "usage: gh-view {pr|issue} {number}"
	exit 1
fi
