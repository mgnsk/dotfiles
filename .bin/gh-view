#!/usr/bin/env bash

set -euo pipefail

target="$1"
number="$2"

if [ "$number" == "" ]; then
	echo "number argument empty"
	exit 1
fi

pr_query="$(
	cat <<-'EOF'
		query($name: String!, $owner: String!, $number: Int!) {
			repository(owner: $owner, name: $name) {
				pullRequest(number: $number) {
					number,
					title,
					url,
					createdAt,
					state,
					author {
						login
					},
					body,
					comments(last: 100) {
						nodes {
							createdAt,
							url,
							author {
								login
							},
							minimizedReason,
							body
						}
					},
					reviews(last: 100) {
						nodes {
							createdAt,
							url,
							state,
							author {
								login
							},
							minimizedReason,
							body,
							comments(last: 100) {
								nodes {
									createdAt,
									url,
									author {
										login
									},
									minimizedReason,
									position,
									startLine,
									line,
									originalStartLine,
									originalLine,
									diffHunk,
									body
								}
							}
						}
					}
				}
			}
		}
	EOF
)"

pr_jq_template="$(
	cat <<-'EOF'
		.data.repository.pullRequest | {
			number,
			url,
			createdAt,
			author,
			title,
			state,
			body,
			comments: [
				# Comments.
				(.comments.nodes[] | {
					url,
					createdAt,
					author,
					minimizedReason,
					body
				}),

				# Reviews.
				(.reviews.nodes[] | {
					url,
					createdAt,
					state,
					author,
					minimizedReason,
					body
				} | select(.body != "")), # Skip placeholder reviews.

				# Review comments.
				(.reviews.nodes[] | . as $review | .comments.nodes[] | . as $comment | {
					url,
					createdAt,
					state: $review.state,
					author,
					isMinimized,
					minimizedReason,
					body,
					path,
					position,
					startLine,
					line,
					originalStartLine,
					originalLine,
					# Show only lines commented on from hunk.
					diffHunk: [ (.diffHunk | split("\n") | . as $arr | to_entries[] |
						# Note: line numbers are for files not diff, can't use them here unless we see all hunks.
						if $comment.originalStartLine == null and $comment.originalLine != null then
							select(.key > ($arr|length)-5)
						else
							select(true)
						end
						| .value) ] | join("\n")
				})
				] | sort_by(.createdAt)
		}
	EOF
)"

issue_query="$(
	cat <<-'EOF'
		query($name: String!, $owner: String!, $number: Int!) {
			repository(owner: $owner, name: $name) {
				issue(number: $number) {
					number,
					title,
					url,
					createdAt,
					state,
					author {
						login
					},
					body,
					comments(last: 100) {
						nodes {
							createdAt,
							url,
							author {
								login
							},
							body
						}
					}
				}
			}
		}
	EOF
)"

issue_jq_template="$(
	cat <<-'EOF'
		.data.repository.issue | {
			number,
			url,
			createdAt,
			author,
			title,
			state,
			body,
			comments: [
				# Comments.
				(.comments.nodes[] | {
					url,
					createdAt,
					author,
					isMinimized,
					minimizedReason,
					body
				})
			] | sort_by(.createdAt)
		}
	EOF
)"

# Note: italic urls don't work in glow, must use mdcat.
issue_pr_go_template="$(
	cat <<-'EOF'
		# #{{.number}} {{.title}} ({{.state}})
		## *{{timeago .createdAt}} {{printf "(%s)" .author.login}}:*
		*{{.url}}*

		{{.body}}

		{{range .comments}}
			---

			## *{{timeago .createdAt}} {{printf "(%s)" .author.login}}{{if .state}} {{.state}}{{end}}:*
			*{{.url}}*
			{{if .minimizedReason}}*minimized: {{.minimizedReason}}*{{end}}
			{{if .path}}*path: {{.path}}*{{end}}
			{{if .diffHunk}}{{printf "```diff\n%s\n```" .diffHunk}}{{end}}
			{{.body}}
		{{end}}
	EOF
)"

function render {
	rich --markdown --force-terminal --emoji -
	# mdcat -p --ansi --columns "$FZF_PREVIEW_COLUMNS" # https://github.com/swsnr/mdcat
	# glow --pager --style auto --width "$FZF_PREVIEW_COLUMNS"

	# cmark-gfm --to html | elinks -dump -dump-color-mode 3
}

if [ "$target" == "pr" ]; then
	gh api graphql -F owner='{owner}' -F name='{repo}' -F number="$number" -f query="$pr_query" | jq "$pr_jq_template" | gh-tpl "$issue_pr_go_template" | render
	# | render
	# gh pr diff "$number" | delta
elif [ "$target" == "issue" ]; then
	gh api graphql -F owner='{owner}' -F name='{repo}' -F number="$number" -f query="$issue_query" | jq "$issue_jq_template" | gh-tpl "$issue_pr_go_template" | render
else
	echo "usage: gh-view {pr|issue} {number}"
	exit 1
fi
