#!/bin/env bash

set -e

prog="$1"

if [[ "$prog" == "" ]]; then
	echo "Usage: ide {program} [args]"
	exit 1
fi

args=(
	--unshare-all
	--share-net
	--die-with-parent
	--setenv USERHOST_COLOR '\[\e[0;33m\]'
	--dev-bind /dev /dev
	--proc /proc
)

ro_binds=(
	/bin
	/usr
	/lib
	/lib64
	/etc
)

rw_binds=(
	"$PWD"
	"$HOME/go"
	"$HOME/.cargo"
	"$HOME/.local/share/nvim"
	"$HOME/.local/share/phpactor"
	"$HOME/.cache/goimports"
	"$HOME/.cache/gopls"
	"$HOME/.cache/go-build"
	"$HOME/.cache/phpactor"
	"$HOME/.npm-packages"
)

tmpfs_volumes=(
	"/tmp"
	"/run/user/$(id -u)"
	"$HOME/.local/state"
)

for v in "${ro_binds[@]}"; do
	args+=(
		--ro-bind "$v" "$v"
	)
done

for v in "${rw_binds[@]}"; do
	args+=(
		--bind "$v" "$v"
	)
done

for v in "${tmpfs_volumes[@]}"; do
	args+=(
		--tmpfs "$v"
	)
done

# Bind mount all files tracked by dotfiles git.
for f in $(git -C "$HOME" ls-tree -r master --name-only); do
	args+=(
		--bind "$HOME/$f" "$HOME/$f"
	)
done

args+=(
	"$(which "$prog")"
	--
	"${@:2}"
)

bwrap "${args[@]}"
