#!/bin/env bash

set -e

prog="$1"

if [[ "$prog" == "" ]]; then
	echo "Usage: ide {program} [args]"
	exit 1
fi

args=(
	--unshare-all
	--share-net
	--die-with-parent
	--setenv USERHOST_COLOR '\[\e[0;33m\]'
	--dev-bind /dev /dev
	--proc /proc
)

declare -A ro_binds=(
	["/bin"]="/bin"
	["/usr"]="/usr"
	["/lib"]="/lib"
	["/lib64"]="/lib64"
	["/etc"]="/etc"
	["$HOME/.npm-packages"]="$HOME/.npm-packages"
	["$HOME/.go-packages"]="$HOME/.go-packages"
	["$HOME/.rustup"]="$HOME/.rustup"
)

# Mount all files tracked by dotfiles git.
for f in $(git -C "$HOME" ls-tree -r master --name-only); do
	ro_binds["$HOME/$f"]="$HOME/$f"
done

# Create persistent volumes.
mkdir -p \
	"$HOME/.ide/go" \
	"$HOME/.ide/.cargo" \
	"$HOME/.ide/.local" \
	"$HOME/.ide/.cache"

declare -A rw_binds=(
	["$PWD"]="$PWD"
	["$HOME/.ide/go"]="$HOME/go"
	["$HOME/.ide/.cargo"]="$HOME/.cargo"
	["$HOME/.ide/.local"]="$HOME/.local"
	["$HOME/.ide/.cache"]="$HOME/.cache"
)

tmpfs_volumes=(
	"/tmp"
	"/run/user/$(id -u)"
)

for key in "${!ro_binds[@]}"; do
	args+=(
		--ro-bind "$key" "${ro_binds[$key]}"
	)
done

for key in "${!rw_binds[@]}"; do
	args+=(
		--bind "$key" "${rw_binds[$key]}"
	)
done

for v in "${tmpfs_volumes[@]}"; do
	args+=(
		--tmpfs "$v"
	)
done

args+=(
	"$(which "$prog")"
	--
	"${@:2}"
)

bwrap "${args[@]}"
