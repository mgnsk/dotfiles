#!/bin/env bash

set -e

prog="$1"

if [[ "$prog" == "" ]]; then
	echo "Usage: ide {program} [args]"
	exit 1
fi

# Proxy org.freedesktop.secrets service.
# Security: the provider on host asks for GUI confirmation on secret access.
sockfile="$XDG_RUNTIME_DIR/ide-xdg-dbus-proxy-$$.sock"

xdg-dbus-proxy "$DBUS_SESSION_BUS_ADDRESS" "$sockfile" \
	--filter \
	--call=org.freedesktop.secrets=* \
	--call=com.canonical.SafeLauncher=com.canonical.SafeLauncher.OpenURL@/ &

proxy_pid=$!

function cleanup {
	kill -9 "$proxy_pid"
	rm -f "$sockfile"
}

trap cleanup EXIT

args=(
	--unshare-all
	--share-net
	--die-with-parent
	--setenv USERHOST_COLOR '\[\e[0;33m\]'
	--dev /dev
	--proc /proc
	--tmpfs /tmp
	--cap-drop ALL
	--setenv DBUS_SESSION_BUS_ADDRESS "unix:path=$XDG_RUNTIME_DIR/bus"
	--ro-bind "$sockfile" "$XDG_RUNTIME_DIR/bus"
	--ro-bind "/bin" "/bin"
	--ro-bind "/usr" "/usr"
	--ro-bind "/lib" "/lib"
	--ro-bind "/lib64" "/lib64"
	--ro-bind "/etc" "/etc"
	--ro-bind /usr/lib/snapd-xdg-open/xdg-open /usr/bin/xdg-open
	--ro-bind "$HOME/.npm-packages" "$HOME/.npm-packages"
	--ro-bind "$HOME/.rustup" "$HOME/.rustup"
	--bind "$PWD" "$PWD"
)

# Read bind all files tracked by dotfiles git.
for f in $(git -C "$HOME" ls-tree -r master --name-only); do
	args+=(
		--ro-bind "$HOME/$f" "$HOME/$f"
	)
done

# Detect current project root.
project=$(git rev-parse --show-toplevel)

# Fall back to PWD if no repo found.
if [[ "$project" == "$HOME" ]]; then
	project="$PWD"
fi

function add_volume() {
	container_path="$1"

	# Replace every (//) slash (\/) with underscore (_) and append a unique hash.
	volume_name="${project//\//_}-$(echo -n "$project" | sha256sum | cut -c1-8)"

	host_path="$HOME/.ide/$volume_name/$container_path"
	mkdir -p "$host_path"

	args+=(
		--bind "$host_path" "$container_path"
	)
}

# Create per-project persistent volumes.
add_volume "$HOME/.cache"
add_volume "$HOME/.cargo"
add_volume "$HOME/.local"
add_volume "$HOME/go"

args+=(
	"$prog"
	--
	"${@:2}"
)

exec bwrap "${args[@]}"
