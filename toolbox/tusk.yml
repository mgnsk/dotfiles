---
interpreter: bash -eu -o pipefail -c

options:
  container-uid:
    default: 3000
  container-gid:
    default: 3000
  container-user:
    default: dev
  container-group:
    default: dev
  host-home:
    environment: HOME

tasks:
  setup:
    usage: Set up rootless podman for host machine.
    run:
      - command: sudo sysctl kernel.unprivileged_userns_clone=1
      - command: sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 $(id -un)
      - command: podman system migrate
      - command: podman run --rm hello-world

  _build:
    private: true
    run:
      - command: >
          podman build --jobs=0
          --build-arg uid=${container-uid}
          --build-arg gid=${container-gid}
          --build-arg user=${container-user}
          --build-arg group=${container-group}
          -t toolbox:latest
          -f Dockerfile
          .

  build:
    usage: Build the production toolbox image.
    run:
      - command: rm -rf dotfiles
      - command: git clone git@github.com:mgnsk/dotfiles.git dotfiles
      # Remove git dir to keep build.dev podman cache if any.
      - command: rm -rf dotfiles/.git
      - task: _build

  build.dev:
    usage: Build the development toolbox image from host's dotfiles.
    run:
      - command: rm -rf dotfiles
      - command: mkdir -p dotfiles
      - command:
          dir: ${host-home}
          exec: git --git-dir=${host-home}/.dotfiles --work-tree=${host-home} ls-files | tar Tc - | tar Cx ${host-home}/toolbox/dotfiles
      - task: _build

  # TODO: https://github.com/containers/podman/issues/16541
  nvim:
    usage: Run neovim in the absolute directory.
    args:
      workspace:
        usage: The absolute path for the workspace directory to run in.
    options:
      host-term:
        environment: TERM
      timezone:
        default:
          command: timedatectl show | grep Timezone | cut -d= -f2
    run:
      - command: podman volume create --ignore toolbox-go
      - command: podman volume create --ignore toolbox-cargo
      - command: >
          podman run
          --interactive
          --tty
          --rm
          --pull=never
          --env TERM=${host-term}
          --env TZ=${timezone}
          --hostname toolbox
          --network host
          --userns=keep-id:uid=${container-uid},gid=${container-gid}
          --tmpfs /tmp:rw,exec,nosuid,nodev
          --tmpfs /home/${container-user}/.local:rw,exec,nosuid,nodev
          --tmpfs /home/${container-user}/.cache:rw,noexec,nosuid,nodev
          --volume toolbox-go:/home/${container-user}/go
          --volume toolbox-cargo:/home/${container-user}/.cargo
          --volume ${workspace}:${workspace}:Z
          --workdir ${workspace}
          toolbox:latest
          fish -c tmux
