---
interpreter: bash -eu -o pipefail -c

options:
  container-uid:
    default: 3000
  container-gid:
    default: 3000
  container-user:
    default: dev
  container-group:
    default: dev
  host-home:
    environment: HOME

tasks:
  setup:
    usage: Set up rootless podman for host machine.
    run:
      - command: sudo sysctl kernel.unprivileged_userns_clone=1
      - command: sudo usermod --add-subuids 100000-165535 --add-subgids 100000-165535 $(id -un)
      - command: podman system migrate
      - command: podman run --rm hello-world

  build:
    usage: Build the production toolbox image.
    options:
      tmp:
        default:
          command: mktemp -d
    run:
      - when:
          - exists: dotfiles
          - command: git -C dotfiles pull
      - when:
          - not-exists: dotfiles
          - command: git clone git@github.com:mgnsk/dotfiles.git dotfiles
      - command: >
          podman build --jobs=0
          --build-arg uid=${container-uid}
          --build-arg gid=${container-gid}
          --build-arg user=${container-user}
          --build-arg group=${container-group}
          -t toolbox:latest
          -f Dockerfile
          .
    finally:
      - command: rm -rf ${tmp}

  build-dev:
    usage: Build the development toolbox image from host's dotfiles.
    options:
      tmp:
        default:
          command: mktemp -d
    run:
      - command:
          dir: ${host-home}
          exec: git --git-dir=${host-home}/.dotfiles --work-tree=${host-home} ls-files | tar Tc - | tar Cx ${tmp}
      - command: mkdir -p ${host-home}/toolbox/dotfiles
      - command: >
          rsync -av
          --checksum
          --no-perms
          --no-owner
          --no-group
          --omit-dir-times
          --delete-after
          --delay-updates
          --exclude=toolbox
          ${tmp}/
          ${host-home}/toolbox/dotfiles
      - command: >
          podman build --jobs=0
          --build-arg uid=${container-uid}
          --build-arg gid=${container-gid}
          --build-arg user=${container-user}
          --build-arg group=${container-group}
          -t toolbox:latest
          -f Dockerfile
          .
    finally:
      - command: rm -rf ${tmp}

  # TODO: https://github.com/containers/podman/issues/16541
  sh:
    usage: Run a new toolbox shell.
    options:
      host-term:
        environment: TERM
    run:
      - command: podman volume create --ignore toolbox-go
      - command: podman volume create --ignore toolbox-cargo
      - command: >
          podman run
          --interactive
          --tty
          --rm
          --pull=never
          --env TERM=${host-term}
          --hostname toolbox
          --network host
          --userns=keep-id:uid=${container-uid},gid=${container-gid}
          --tmpfs /tmp:rw,exec,nosuid,nodev
          --tmpfs /home/${container-user}/.local:rw,exec,nosuid,nodev
          --tmpfs /home/${container-user}/.cache:rw,noexec,nosuid,nodev
          --volume toolbox-go:/home/${container-user}/go
          --volume toolbox-cargo:/home/${container-user}/.cargo
          --volume ${host-home}/toolbox/workspaces:/workspaces:Z
          --workdir /workspaces
          toolbox:latest
          fish
