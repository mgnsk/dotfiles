---
interpreter: bash -eu -o pipefail -c

options:
  container-uid:
    default:
      command: id -u
  container-gid:
    default:
      command: id -g
  container-user:
    default: dev
  container-group:
    default: dev
  host-home:
    environment: HOME

tasks:
  _dotfiles.prod:
    private: true
    run:
      - command: rm -rf dotfiles
      - command: git clone git@github.com:mgnsk/dotfiles.git dotfiles
      # Remove git dir to keep build cache if any.
      - command: rm -rf dotfiles/.git

  _dotfiles.dev:
    private: true
    run:
      - command: rm -rf dotfiles
      - command: mkdir -p dotfiles
      - command:
          dir: ${host-home}
          exec: git --git-dir=${host-home}/.dotfiles --work-tree=${host-home} ls-files | tar Tc - | tar Cx ${host-home}/toolbox/dotfiles

  build:
    usage: Build the production toolbox image.
    options:
      dev:
        type: bool
    run:
      - when:
          equal: {dev: true}
        task: _dotfiles.dev

      - when:
          equal: {dev: false}
        task: _dotfiles.prod

      # Note: setting ulimit fixes the fakeroot slowness issue.
      # https://github.com/greyltc-org/docker-archlinux-aur/issues/7#issuecomment-1516028357
      - command: >
          docker build
          --ulimit nofile=1024:10240
          --build-arg uid=${container-uid}
          --build-arg gid=${container-gid}
          --build-arg user=${container-user}
          --build-arg group=${container-group}
          -t toolbox:latest
          -f Dockerfile
          .

  sh:
    usage: Run a new shell in the absolute directory.
    args:
      workspace:
        usage: The absolute path for the workspace directory to run in.
    options:
      host-term:
        environment: TERM
      timezone:
        default:
          command: timedatectl show | grep Timezone | cut -d= -f2
    run:
      - command: docker volume create ide-go || true
      - command: docker volume create ide-cargo || true
      - command: >
          docker run
          --interactive
          --tty
          --rm
          --pull=never
          --env TERM=${host-term}
          --env TZ=${timezone}
          --env TOOLBOX_ENV=true
          --hostname toolbox
          --network host
          --tmpfs /tmp:rw,exec,nosuid,nodev,mode=777
          --tmpfs /home/${container-user}/.local/state:rw,exec,nosuid,nodev,mode=777
          --tmpfs /home/${container-user}/.cache:rw,noexec,nosuid,nodev,mode=777
          --volume ide-go:/home/${container-user}/go
          --volume ide-cargo:/home/${container-user}/.cargo
          --volume ${workspace}:${workspace}:Z
          --workdir ${workspace}
          toolbox:latest
          fish
