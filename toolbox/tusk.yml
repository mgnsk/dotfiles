---
interpreter: bash -eu -o pipefail -c

options:
  container-uid:
    default: 3000
  container-gid:
    default: 3000
  container-user:
    default: dev
  container-group:
    default: dev
  host-home:
    environment: HOME

tasks:
  build:
    options:
      nproc:
        default:
          command: nproc
    usage: Build the toolbox image.
    run:
      - task: _setup-dotfiles
      - command: >
          podman build --jobs ${nproc}
          --build-arg uid=${container-uid}
          --build-arg gid=${container-gid}
          --build-arg user=${container-user}
          --build-arg group=${container-group}
          -t toolbox:latest
          -f Dockerfile
          .

  # TODO: https://github.com/containers/podman/issues/16541
  run:
    usage: Run the toolbox shell.
    options:
      host-term:
        environment: TERM
    run:
      - command: podman volume create --ignore toolbox-go
      - command: podman volume create --ignore toolbox-cargo
      - command: >
          podman run
          --interactive
          --tty
          --rm
          --pull=never
          --env TERM=${host-term}
          --hostname toolbox
          --network host
          --userns=keep-id:uid=${container-uid},gid=${container-gid}
          --tmpfs /tmp:rw,exec,nosuid,nodev
          --tmpfs /home/${container-user}/.local/state:rw,noexec,nosuid,nodev
          --tmpfs /home/${container-user}/.cache:rw,noexec,nosuid,nodev
          --volume toolbox-go:/home/${container-user}/go
          --volume toolbox-cargo:/home/${container-user}/cargo
          --volume ${host-home}/toolbox/workspaces:/workspaces:Z
          --workdir /workspaces
          toolbox:latest
          fish

  _setup-dotfiles:
    private: true
    options:
      tmp:
        default:
          command: mktemp -d
    run:
      - command:
          dir: ${host-home}
          exec: git --git-dir=${host-home}/.dotfiles --work-tree=${host-home} ls-files | tar Tc - | tar Cx ${tmp}
      - command: mkdir -p ${host-home}/toolbox/dotfiles
      - command: >
          rsync -av
          --checksum
          --no-perms
          --no-owner
          --no-group
          --omit-dir-times
          --delete-after
          --delay-updates
          --exclude=toolbox
          ${tmp}/
          ${host-home}/toolbox/dotfiles
    finally:
      - command: rm -rf ${tmp}
