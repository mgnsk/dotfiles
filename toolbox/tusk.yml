---
options:
  uid:
    default:
      command: id -u
  gid:
    default:
      command: id -g
  user:
    default:
      command: id -u -n
  group:
    default:
      command: id -g -n
  tmp:
    default:
      command: echo $PWD/.tmp

tasks:
  build:
    usage: Build the toolbox.
    run:
      - command: >
          podman
          build
          --build-arg uid=${uid}
          --build-arg gid=${gid}
          --build-arg user=${user}
          --build-arg group=${group}
          --build-arg cachebust=$(date +%s)
          -t toolbox
          toolbox
      - command: podman image prune -f

  up:
    usage: Start the toolbox.
    run:
      - command: mkdir -p ${tmp}/lowerdir ${tmp}/workdir ${tmp}/workspaces
      # TODO: is id mapping already supported?
      - command: >
          podman
          unshare
          fuse-overlayfs
          -o uidmapping=0:${uid}:1
          -o gidmapping=0:${gid}:1
          -o lowerdir=${tmp}/lowerdir
          -o upperdir=workspaces
          -o workdir=${tmp}/workdir
          -o noxattrs=1,fsync=0,threaded=0
          ${tmp}/workspaces
      - set-environment:
          WORKSPACES_HOST_PATH: ${tmp}/workspaces
      - command: cat toolbox.yml | envsubst | podman play kube -

  down:
    usage: Stop the toolbox.
    run:
      - command: podman pod stop toolbox || true
      - command: podman pod rm -f toolbox || true
      - command: podman unshare fusermount3 -u ${tmp}/workspaces || true
      - command: rm -rf ${tmp}

  clean:
    usage: Stop the toolbox and remove volumes.
    run:
      - task: down
      - command: for v in $(podman volume ls --quiet | grep "^toolbox"); do podman volume rm $v; done

  shell:
    usage: Enter the toolbox.
    options:
      ctr-id:
        default:
          command: podman container list --filter ancestor=localhost/toolbox --format "{{.ID}}"
    run:
      - command: podman exec -it ${ctr-id} fish
